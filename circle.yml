machine:
  environment:
    MOCHA_FILE: $CIRCLE_TEST_REPORTS/junit/test-results.xml

    MAXMIND_DB: ./tmp/maxmind/GeoLite2-City.mmdb

    SEQUELIZE_HOST: localhost
    SEQUELIZE_DATABASE: messagebot_development
    SEQUELIZE_PASSWORD:

    REDIS_HOST: 127.0.0.1
    REDIS_PORT: 6379
    REDIS_DB: 1
    REDIS_PASS:

    ELASTICSEARCH_VERSION: 2.3.4
    ELASTICSEARCH_URLS: http://localhost:9200

  services:
    - mysql
    - postgresql
    - redis

dependencies:
  cache_directories:
    - tmp/kibana
    - tmp/maxmind
    - public/bower_components

  post:
    # Install ElaticSearch
    - curl -O https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/$ELASTICSEARCH_VERSION/elasticsearch-$ELASTICSEARCH_VERSION.deb
    - sudo dpkg -i --force-confnew elasticsearch-$ELASTICSEARCH_VERSION.deb
    - sudo service elasticsearch restart
    - sleep 10
    - curl --retry 10 --retry-delay 5 -v http://127.0.0.1:9200

test:
  override:
    # TESTING NODE V4.X
    - nvm install 4 && nvm use 4
    - rm -rf node_modules && npm install
    - SEQUELIZE_DIALECT=mysql    SEQUELIZE_USER=root     SEQUELIZE_PORT=3306 npm test
    - SEQUELIZE_DIALECT=postgres SEQUELIZE_USER=postgres SEQUELIZE_PORT=5432 npm test

    # TESTING NODE V6.X
    - nvm install 6 && nvm use 6
    - rm -rf node_modules && npm install
    - SEQUELIZE_DIALECT=mysql    SEQUELIZE_USER=root     SEQUELIZE_PORT=3306 npm test
    - SEQUELIZE_DIALECT=postgres SEQUELIZE_USER=postgres SEQUELIZE_PORT=5432 npm test
