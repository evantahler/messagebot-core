#!/usr/bin/env node

var optimist = require('optimist')
var path = require('path')

var ActionHeroPrototype = require(process.cwd() + '/node_modules/actionhero/actionhero.js')
var actionhero = new ActionHeroPrototype()
var configChanges = {
  logger: [],
  general: { developmentMode: false }
}

actionhero.initialize({configChanges: configChanges}, function (error, api) {
  if (error) { throw error }

  console.log('--------------------------')
  console.log('----- MessageBot CLI -----')
  console.log('--------------------------\r\n')

  var end = function (error) {
    if (error) {
      console.error(error.message)
      setTimeout(process.exit, 500, 1)
    } else {
      setTimeout(process.exit, 500, 0)
    }
  }

  try {
    var commands = []
    if (!optimist.argv._ || optimist.argv._.length === 0) { commands.push('help') }
    optimist.argv._.forEach(function (arg) { commands.push(arg) })

    var runner = require(path.join(__dirname, 'methods', commands.join('/') + '.js'))
    runner(api, end)
  } catch (e) {
    console.error('Error: `' + commands.join(' ') + '` is not a method I can perform.')
    console.error('run `bin/messagebot help` to learn more.')
    end(e)
  }
})
